<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SolMemetics VIP</title>
  <style>
    /* Basic styling for tabs and UI */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tab { display: none; }
    .tab.active { display: block; }
    .tab-button { cursor: pointer; padding: 10px; margin: 5px; }
    #status { color: red; }
    #suggestion-input, #amount-input { margin: 10px; }
    #token-select { margin: 10px; }
    #chat-messages { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h1>SolMemetics VIP</h1>
  <div id="status">Loading...</div>
  <div>
    <button class="tab-button" onclick="switchTab('info')">Info</button>
    <button class="tab-button" onclick="switchTab('suggestions')">Suggestions</button>
    <button class="tab-button" onclick="switchTab('chat')">Chat</button>
  </div>
  <div id="info" class="tab">
    <h2>Info</h2>
    <p>Wallet: <span id="wallet-address">Not connected</span></p>
    <p>Username: <span id="username">Not set</span></p>
    <p>Rank: <span id="rank">Unknown</span></p>
    <p>Balance: <span id="balance">0</span> SMM</p>
    <button id="set-username-btn" disabled>Set Username</button>
  </div>
  <div id="suggestions" class="tab">
    <h2>Suggestions</h2>
    <input id="suggestion-input" type="text" placeholder="Enter your suggestion">
    <select id="token-select">
      <option value="So11111111111111111111111111111111111111112" data-icon="/images/sol.png">SOL</option>
      <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" data-icon="/images/usdc.png">USDC</option>
      <option value="BbDK2SdFKstCuCjF152jWaRVmJMV7hHUW4xYvdMbjups" data-icon="/images/smm.png">SMM</option>
    </select>
    <input id="amount-input" type="number" placeholder="Amount" min="0" step="0.01">
    <button id="submit-suggestion-btn">Submit Suggestion</button>
    <div id="suggestions-list"></div>
  </div>
  <div id="chat" class="tab">
    <h2>Chat</h2>
    <div id="chat-messages"></div>
    <input id="chat-input" type="text" placeholder="Type a message">
    <button id="send-message-btn">Send</button>
  </div>

  <script src="/js/buffer.js"></script>
  <script>
    // Load Buffer from buffer.js
    try {
      if (typeof buffer !== 'undefined' && buffer.Buffer) {
        window.Buffer = buffer.Buffer;
        console.log('Buffer loaded from bundle:', typeof window.Buffer, 'Buffer.from:', typeof window.Buffer.from);
        Object.defineProperty(window, 'Buffer', {
          value: window.Buffer,
          writable: false,
          configurable: false
        });
      } else {
        throw new Error('Buffer module not found in bundle');
      }
    } catch (err) {
      console.error('Error loading Buffer from bundle:', err.message);
      document.getElementById('status').textContent = 'Error: Failed to load Buffer library. Please refresh the page.';
    }

    // Verify Buffer availability
    if (!window.Buffer || !window.Buffer.from) {
      console.error('Buffer or Buffer.from is not defined. Donation functionality may not work.');
      document.getElementById('status').textContent = 'Error: Buffer library not loaded. Please refresh the page.';
    } else {
      console.log('Buffer status:', { Buffer: typeof window.Buffer, BufferFrom: typeof window.Buffer.from });
      console.log('Test Buffer.from:', window.Buffer.from('test', 'utf8').toString('hex'));
    }
  </script>
  <script src="https://unpkg.com/@solana/web3.js@1.98.2/lib/index.iife.min.js"></script>
  <script>
    console.log('solanaWeb3 loaded successfully:', typeof solanaWeb3);

    // Wallet and connection variables
    let walletAddress = null;
    let connection = null;
    let rank = 'Unknown';
    let balance = 0;
    let username = 'Not set';
    let isAdmin = false;

    // Initialize Solana connection
    async function getConnection() {
      try {
        console.log('Attempting connection to RPC 1: https://silent-fluent-diamond.solana-mainnet.quiknode.pro/bdf6a6133f8736f5bf9097f4628841fe18b60bcc');
        connection = new solanaWeb3.Connection('https://silent-fluent-diamond.solana-mainnet.quiknode.pro/bdf6a6133f8736f5bf9097f4628841fe18b60bcc', 'confirmed');
        console.log('Connected to RPC:', connection.rpcEndpoint);
      } catch (error) {
        console.error('Error connecting to RPC:', error.message);
        document.getElementById('status').textContent = 'Error: Failed to connect to Solana network.';
      }
    }

    // Update VIP info
    async function updateVipInfo(wallet) {
      console.log('Updating VIP info for:', wallet);
      try {
        const publicKey = new solanaWeb3.PublicKey(wallet);
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(publicKey, {
          mint: new solanaWeb3.PublicKey('BbDK2SdFKstCuCjF152jWaRVmJMV7hHUW4xYvdMbjups') // SMM
        });
        balance = tokenAccounts.value.reduce((sum, acc) => sum + (acc.account.data.parsed.info.tokenAmount.uiAmount || 0), 0);
        rank = balance >= 10000000 ? 'Rhodium' : 'Standard';
        console.log('VIP info updated:', { balance, rank });
        document.getElementById('balance').textContent = balance.toFixed(2);
        document.getElementById('rank').textContent = rank;
      } catch (error) {
        console.error('Error updating VIP info:', error.message);
      }
    }

    // Load username
    async function loadUsername(wallet) {
      console.log('Fetching username for:', wallet);
      try {
        const response = await fetch('https://smm-chat-server.onrender.com/users');
        const users = await response.json();
        const user = users.find(u => u.wallet === wallet);
        username = user ? user.username : 'Not set';
        isAdmin = user ? user.isAdmin : false;
        console.log('Loaded username:', username);
        document.getElementById('username').textContent = username;
        document.getElementById('set-username-btn').disabled = !isAdmin;
        console.log('Disabling set username button for non-admin');
      } catch (error) {
        console.error('Error fetching username:', error.message);
      }
    }

    // Populate token dropdown
    async function populateTokenDropdown(wallet) {
      console.log('Populating token dropdown for:', wallet);
      try {
        const publicKey = new solanaWeb3.PublicKey(wallet);
        const balanceSol = await connection.getBalance(publicKey);
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(publicKey, {
          programId: new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGK7y5T2zTXy8gC8s9C34YH7n')
        });
        const tokens = [
          { mint: 'So11111111111111111111111111111111111111112', symbol: 'SOL', balance: balanceSol / solanaWeb3.LAMPORTS_PER_SOL },
          { mint: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', symbol: 'USDC', balance: 0 },
          { mint: 'BbDK2SdFKstCuCjF152jWaRVmJMV7hHUW4xYvdMbjups', symbol: 'SMM', balance: 0 }
        ];
        tokenAccounts.value.forEach(acc => {
          const mint = acc.account.data.parsed.info.mint;
          const balance = acc.account.data.parsed.info.tokenAmount.uiAmount;
          const token = tokens.find(t => t.mint === mint);
          if (token) token.balance = balance;
        });
        const select = document.getElementById('token-select');
        select.innerHTML = tokens.map(t => `<option value="${t.mint}" data-icon="/images/${t.symbol.toLowerCase()}.png">${t.symbol} (${t.balance})</option>`).join('');
        console.log('Token dropdown populated, options:', tokens);
      } catch (error) {
        console.error('Error populating token dropdown:', error.message);
      }
    }

    // Load suggestions
    async function loadSuggestions() {
      console.log('Loading suggestions');
      try {
        const response = await fetch('https://smm-chat-server.onrender.com/suggestions');
        const suggestions = await response.json();
        console.log('Loaded suggestions:', suggestions.length);
        document.getElementById('suggestions-list').innerHTML = suggestions.length ? suggestions.map(s => `<p>${s.suggestion} (${s.token}, ${s.amount})</p>`).join('') : 'No suggestions yet.';
      } catch (error) {
        console.error('Error loading suggestions:', error.message);
      }
    }

    // WebSocket for chat
    function connectWebSocket(wallet, rank) {
      console.log('Connecting WebSocket for:', wallet, 'with rank:', rank);
      const ws = new WebSocket('wss://smm-chat-server.onrender.com');
      ws.onopen = () => console.log('WebSocket connected');
      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        displayMessage(message);
      };
      ws.onerror = (error) => console.error('WebSocket error:', error);
      document.getElementById('send-message-btn').onclick = () => {
        const input = document.getElementById('chat-input');
        if (input.value && wallet) {
          ws.send(JSON.stringify({ wallet, rank, username, message: input.value }));
          input.value = '';
        }
      };
    }

    function displayMessage({ rank, username, message, timestamp }) {
      const messages = document.getElementById('chat-messages');
      const msgDiv = document.createElement('div');
      msgDiv.textContent = `${rank} ${username}: ${message} at ${new Date(timestamp).toLocaleTimeString()}`;
      messages.appendChild(msgDiv);
      messages.scrollTop = messages.scrollHeight;
      console.log('Displayed message:', msgDiv.textContent);
    }

    // Send donation
    async function sendDonation(wallet, tokenMint, amount, suggestion) {
      console.log('sendDonation called:', { wallet, tokenMint, amount, suggestion });
      console.log('Phantom status:', { available: !!window.solana, isPhantom: !!window.solana?.isPhantom });
      console.log('sendDonation Buffer:', window.Buffer, typeof window.Buffer?.from);
      try {
        if (!window.Buffer || !window.Buffer.from) {
          throw new Error('Buffer not available');
        }
        if (!window.solana || !window.solana.isPhantom) {
          throw new Error('Phantom wallet not available');
        }
        await window.solana.connect();
        const response = await fetch('https://smm-chat-server.onrender.com/submit-suggestion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet, suggestion, tokenMint, amount })
        });
        const data = await response.json();
        if (!data.transaction) {
          throw new Error('No transaction returned from server');
        }
        const transactionBuffer = window.Buffer.from(data.transaction, 'base64');
        const transaction = solanaWeb3.Transaction.from(transactionBuffer);
        const { signature } = await window.solana.signAndSendTransaction(transaction);
        console.log('Transaction sent, signature:', signature);
        await fetch('https://smm-chat-server.onrender.com/confirm-suggestion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signature, wallet, suggestion, tokenMint, amount })
        });
        document.getElementById('status').textContent = 'Suggestion and donation submitted successfully!';
        loadSuggestions();
      } catch (error) {
        console.error('Error sending donation:', error.message, error);
        document.getElementById('status').textContent = `Error sending donation: ${error.message}`;
      }
    }

    // Tab switching
    function switchTab(tabId) {
      console.log('Tab button clicked:', tabId);
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // Check VIP access
    async function checkVipAccess() {
      console.log('Checking VIP access');
      try {
        if (!window.solana) {
          document.getElementById('status').textContent = 'Please install Phantom wallet.';
          return;
        }
        console.log('Checking wallet connection status');
        await window.solana.connect({ onlyIfTrusted: true }).catch(() => {});
        if (window.solana.isConnected) {
          walletAddress = window.solana.publicKey.toString();
          console.log('Wallet connected:', walletAddress);
          if (sessionStorage.getItem('vipAccess') === walletAddress) {
            console.log('VIP access verified via sessionStorage');
          } else {
            // Add your VIP access check logic here
            sessionStorage.setItem('vipAccess', walletAddress);
          }
        } else {
          document.getElementById('status').textContent = 'Please connect your Phantom wallet.';
          return;
        }
        document.getElementById('wallet-address').textContent = walletAddress;
        console.log('Initializing UI for:', walletAddress);
        await getConnection();
        await updateVipInfo(walletAddress);
        await loadUsername(walletAddress);
        await populateTokenDropdown(walletAddress);
        await loadSuggestions();
        connectWebSocket(walletAddress, rank);
        console.log('UI initialization complete');
      } catch (error) {
        console.error('Error checking VIP access:', error.message);
        document.getElementById('status').textContent = 'Error: Failed to initialize VIP access.';
      }
    }

    // Event listeners
    console.log('Attaching button event listeners');
    document.getElementById('set-username-btn').onclick = async () => {
      console.log('Set Username button clicked');
      console.log('Username button state:', { currentUsername: username, isAdmin, user: walletAddress });
      // Add username setting logic here
    };
    document.getElementById('submit-suggestion-btn').onclick = async () => {
      console.log('Submit suggestion button clicked (post-wallet)');
      const suggestion = document.getElementById('suggestion-input').value;
      const tokenMint = document.getElementById('token-select').value;
      const amount = parseFloat(document.getElementById('amount-input').value);
      console.log('Submit suggestion inputs:', { suggestion, token: tokenMint, amount });
      if (suggestion && tokenMint && amount > 0) {
        console.log('Submitting suggestion:', { wallet: walletAddress, suggestion, token: tokenMint, amount });
        await sendDonation(walletAddress, tokenMint, amount, suggestion);
      } else {
        document.getElementById('status').textContent = 'Please fill all fields.';
      }
    };

    // Initialize
    console.log('Page loaded, initiating VIP access check');
    checkVipAccess();
  </script>
</body>
</html>