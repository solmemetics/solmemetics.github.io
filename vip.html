<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solmemetics VIP Zone</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
    }
    h1 {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    p {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .retry-button {
      padding: 12px 24px;
      font-size: 16px;
      background: red;
      color: white;
      border: none;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
      font-weight: bold;
    }
    .retry-button:hover {
      background-color: darkred;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
    }
    .retry-button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #ccc;
      font-weight: bold;
    }
    #vip-info, #chat-container, #suggestions-container, #staking-container {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      width: 100%;
      max-width: 800px;
      text-align: left;
    }
    #vip-rank {
      font-weight: bold;
      color: #ffd700;
    }
    .tab-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      background: red;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      font-weight: bold;
    }
    .tab-button.active {
      background: darkred;
    }
    .tab-button:hover:not(.active) {
      background: #ff3333;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    #chat-messages, #suggestions-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      background: #222;
      border-radius: 5px;
    }
    .chat-message {
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      background: #333;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-user {
      width: 200px;
      flex-shrink: 0;
    }
    .chat-user span.rank {
      display: block;
      font-size: 12px;
    }
    .chat-text {
      flex-grow: 1;
      white-space: pre-wrap;
      word-break: break-word;
      margin-left: 20px;
    }
    .chat-message hr {
      border: none;
      border-top: 1px solid #444;
      margin: 5px 0;
    }
    .delete-btn {
      color: red;
      cursor: pointer;
      margin-left: 10px;
      font-weight: bold;
    }
    #chat-input {
      width: 70%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: #333;
      color: white;
      font-weight: bold;
    }
    #set-username-btn {
      margin-left: 10px;
    }
    #username-input {
      display: none;
      width: 60%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: #333;
      color: white;
      font-weight: bold;
      margin-top: 10px;
    }
    #suggestion-input {
      width: 60%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: #333;
      color: white;
      font-weight: bold;
      margin: 10px 0;
    }
    #suggestions-list p {
      margin: 5px 0;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #rewards-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #rewards-table th, #rewards-table td {
      padding: 10px;
      border: 1px solid #444;
      text-align: left;
    }
    .rank-bronze { color: #cd7f32; }
    .rank-silver { color: #c0c0c0; }
    .rank-gold { color: #ffd700; }
    .rank-platinum { color: #e5e4e2; }
    .rank-rhodium { color: #b9f2ff; }
    img {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 100%;
      height: auto;
    }
  </style>
  <script src="https://unpkg.com/@solana/web3.js@1.98.2/lib/index.iife.min.js"></script>
</head>
<body>
  <img src="/images/smm.png" alt="SMM Logo" />
  <h1>Welcome to the SMM VIP Zone</h1>
  <p>Building new things here every few days.</p>

  <div class="tab-nav">
    <button class="tab-button active" data-tab="info">Profile</button>
    <button class="tab-button" data-tab="chat">Chat</button>
    <button class="tab-button" data-tab="suggestions">Suggestions</button>
    <button class="tab-button" data-tab="staking">Staking</button>
  </div>

  <div id="info" class="tab-content active">
    <div id="vip-info">
      <p>Your SMM Balance: <span id="vip-balance">0</span> SMM</p>
      <p>Your VIP Rank: <span id="vip-rank">Loading...</span></p>
      <p>Username: <span id="username-display">Not set</span></p>
      <button id="set-username-btn" class="retry-button">Set Username</button>
      <input id="username-input" type="text" placeholder="Set username...">
    </div>
  </div>
  <div id="chat" class="tab-content">
    <div id="chat-container">
      <div id="chat-messages"></div>
      <input id="chat-input" type="text" placeholder="Type a message...">
      <button id="send-chat" class="retry-button">Send</button>
    </div>
  </div>
  <div id="suggestions" class="tab-content">
    <div id="suggestions-container">
      <div id="suggestions-list"></div>
      <input id="suggestion-input" type="text" placeholder="Enter your suggestion...">
      <button id="submit-suggestion" class="retry-button">Submit Suggestion</button>
    </div>
  </div>
  <div id="staking" class="tab-content">
    <div id="staking-container">
      <table id="rewards-table">
        <thead>
          <tr>
            <th>SMM Balance</th>
            <th>Daily Reward</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="rewards-list"></tbody>
      </table>
    </div>
  </div>

  <div id="status"></div>
  <button id="retry" class="retry-button" style="display: none;">Retry Connection</button>

  <script>
    // Global error handler
    window.onerror = (msg, url, line, col, error) => {
      console.error(`Uncaught error: ${msg} at ${url}:${line}:${col}`, error);
      document.getElementById("status").textContent = `Error: ${msg}. Please refresh the page.`;
    };

    // Verify solanaWeb3
    if (typeof solanaWeb3 === 'undefined') {
      console.error("solanaWeb3 is not defined. Ensure the web3.js script loaded correctly.");
      document.getElementById("status").textContent = "Error: Failed to load Solana library. Please refresh the page.";
      throw new Error("solanaWeb3 not defined");
    }
    console.log("solanaWeb3 loaded successfully:", typeof solanaWeb3);

    // Constants and initialization
    const TOKEN_MINT = new solanaWeb3.PublicKey("BbDK2SdFKstCuCjF152jWaRVmJMV7hHUW4xYvdMbjups");
    const VIP_MINIMUM = 100000;
    const ADMIN_WALLET = "J1sjGFj5tTUdWvGEW5TBE4ZC97Fafsqz2Uo5JuhyBeuy";
    const BACKEND_URL = "https://smm-chat-server.onrender.com";
    const WEBSOCKET_URL = "wss://smm-chat-server.onrender.com";
    let ws;
    let retryCount = 0;
    const MAX_RETRIES = 5;
    const RETRY_INTERVAL = 10000;

    const RPC_ENDPOINTS = [
      "https://silent-fluent-diamond.solana-mainnet.quiknode.pro/bdf6a6133f8736f5bf9097f4628841fe18b60bcc",
      solanaWeb3.clusterApiUrl("mainnet-beta"),
      "https://api.mainnet-beta.solana.com"
    ];

    // DOM elements
    const statusDiv = document.getElementById("status");
    const retryBtn = document.getElementById("retry");
    const chatMessages = document.getElementById("chat-messages");
    const suggestionsList = document.getElementById("suggestions-list");
    const setUsernameBtn = document.getElementById("set-username-btn");
    const usernameInput = document.getElementById("username-input");
    const suggestionInput = document.getElementById("suggestion-input");
    const submitSuggestionBtn = document.getElementById("submit-suggestion");
    const sendChatBtn = document.getElementById("send-chat");
    const chatInput = document.getElementById("chat-input");
    const rewardsList = document.getElementById("rewards-list");

    let currentUser = null;
    let userRank = "No Rank";

    // Tab functionality
    document.querySelectorAll(".tab-button").forEach(button => {
      button.addEventListener("click", () => {
        console.log("Tab button clicked:", button.dataset.tab);
        try {
          document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
          button.classList.add("active");
          document.getElementById(button.dataset.tab).classList.add("active");
          if (button.dataset.tab === "suggestions") loadSuggestions();
          if (button.dataset.tab === "staking") loadRewards();
        } catch (err) {
          console.error("Error switching tab:", err.message);
          statusDiv.textContent = `Error switching tab: ${err.message}`;
        }
      });
    });

    // Username setting
    setUsernameBtn.addEventListener("click", async () => {
      console.log("Set Username button clicked");
      try {
        const currentUsername = document.getElementById("username-display").textContent;
        const isAdmin = currentUser === ADMIN_WALLET;
        if (!currentUser) {
          statusDiv.textContent = "Please connect your wallet.";
          console.log("No wallet connected");
          return;
        }
        if (usernameInput.style.display === "none" && (currentUsername === "Not set" || isAdmin)) {
          console.log("Showing username input");
          usernameInput.style.display = "block";
          usernameInput.focus();
          setUsernameBtn.textContent = "Confirm";
        } else if (usernameInput.style.display === "block") {
          console.log("Attempting to submit username");
          const username = usernameInput.value.trim();
          if (!username) {
            statusDiv.textContent = "Please enter a username.";
            console.log("No username entered");
            return;
          }
          if (["dev", "admin", "owner"].includes(username.toLowerCase())) {
            statusDiv.textContent = "Username cannot be 'dev', 'admin', or 'owner'.";
            console.log("Invalid username:", username);
            return;
          }
          console.log("Sending username request");
          const response = await fetch(`${BACKEND_URL}/set-username`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: currentUser, username }),
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error: ${response.status} - ${errorText}`);
          }
          const data = await response.json();
          document.getElementById("username-display").textContent = username;
          statusDiv.textContent = "Username set successfully!";
          usernameInput.style.display = "none";
          usernameInput.value = "";
          setUsernameBtn.textContent = isAdmin ? "Change Username" : "Username Set";
          if (!isAdmin) setUsernameBtn.disabled = true;
          console.log("Username set response:", data);
          sendChatBtn.disabled = false;
          submitSuggestionBtn.disabled = false;
        }
      } catch (err) {
        console.error("Error setting username:", err.message);
        statusDiv.textContent = `Error setting username: ${err.message}`;
        usernameInput.style.display = "none";
        setUsernameBtn.textContent = currentUser === ADMIN_WALLET ? "Change Username" : "Set Username";
      }
    });

    usernameInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        console.log("Enter key pressed in username input");
        setUsernameBtn.click();
      }
    });

    // Solana connection with retry
    async function getConnection(attempt = 0) {
      const rpc = RPC_ENDPOINTS[attempt];
      try {
        const connection = new solanaWeb3.Connection(rpc, { commitment: "confirmed" });
        await connection.getSlot();
        console.log(`Connected to RPC: ${rpc}`);
        return connection;
      } catch (err) {
        console.error(`RPC ${rpc} failed:`, err);
        if (attempt < RPC_ENDPOINTS.length - 1) {
          return getConnection(attempt + 1);
        }
        throw new Error("All RPC endpoints failed");
      }
    }

    // Check wallet and balance
    async function checkWallet() {
      console.log("Checking wallet");
      try {
        if (typeof window.solana === "undefined") {
          statusDiv.textContent = "Phantom wallet not detected. Please install Phantom.";
          console.log("Phantom wallet not detected");
          return;
        }
        const response = await window.solana.connect();
        currentUser = response.publicKey.toBase58();
        console.log("Wallet connected:", currentUser);
        statusDiv.textContent = `Connected as ${currentUser.slice(0, 6)}...${currentUser.slice(-4)}`;

        const connection = await getConnection();
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
          response.publicKey,
          { mint: TOKEN_MINT, programId: solanaWeb3.TOKEN_PROGRAM_ID }
        );
        let tokenBalance = 0;
        for (const { account } of tokenAccounts.value) {
          if (account.data.parsed.info.mint === TOKEN_MINT.toBase58()) {
            tokenBalance = parseFloat(account.data.parsed.info.tokenAmount.uiAmount);
            break;
          }
        }
        console.log("Token balance:", tokenBalance);
        document.getElementById("vip-balance").textContent = tokenBalance.toLocaleString();

        userRank = tokenBalance >= 1000000 ? "Rhodium" :
                   tokenBalance >= 750000 ? "Platinum" :
                   tokenBalance >= 500000 ? "Gold" :
                   tokenBalance >= 250000 ? "Silver" :
                   tokenBalance >= 100000 ? "Bronze" : "No Rank";
        document.getElementById("vip-rank").textContent = userRank;
        document.getElementById("vip-rank").className = `rank-${userRank.toLowerCase().replace(" ", "-")}`;

        if (tokenBalance < VIP_MINIMUM) {
          statusDiv.textContent = `You need at least ${VIP_MINIMUM.toLocaleString()} SMM to access VIP features.`;
          console.log("Insufficient balance for VIP access:", tokenBalance);
          return;
        }

        // Load username
        const usersResponse = await fetch(`${BACKEND_URL}/users`);
        const users = await usersResponse.json();
        const username = users[currentUser] || "Not set";
        document.getElementById("username-display").textContent = username;
        setUsernameBtn.textContent = (username !== "Not set" && currentUser !== ADMIN_WALLET) ? "Username Set" : "Set Username";
        setUsernameBtn.disabled = (username !== "Not set" && currentUser !== ADMIN_WALLET);
        sendChatBtn.disabled = username === "Not set";
        submitSuggestionBtn.disabled = username === "Not set";
        console.log("Username loaded:", username);

        connectWebSocket(userRank, currentUser);
      } catch (err) {
        console.error("Error checking wallet:", err);
        statusDiv.textContent = `Error connecting wallet: ${err.message}`;
        retryBtn.style.display = "block";
      }
    }

    // WebSocket connection for chat
    async function connectWebSocket(rank, userAddress) {
      console.log("Connecting WebSocket");
      try {
        if (retryCount >= MAX_RETRIES) {
          statusDiv.textContent = "Max retry attempts reached. Please click Retry or refresh the page.";
          retryBtn.style.display = "block";
          return;
        }
        ws = new WebSocket(WEBSOCKET_URL);
        ws.onopen = () => {
          statusDiv.textContent = "Connected to chat server!";
          ws.isAuthenticated = true;
          retryCount = 0;
          console.log("WebSocket connected");
          chatMessages.innerHTML = "<p>Chat connected. Waiting for messages...</p>";
          loadMessages();
        };
        ws.onmessage = async (event) => {
          try {
            const msg = JSON.parse(event.data);
            console.log("Received WebSocket message:", msg);
            if (msg.type === "chat") {
              if (!msg.user || !msg.rank || !msg.text || !msg.timestamp) {
                console.warn("Invalid chat message format:", msg);
                return;
              }
              await loadMessages();
            } else if (msg.type === "delete") {
              if (msg.index === undefined) {
                console.warn("Invalid delete message:", msg);
                return;
              }
              await loadMessages();
            }
          } catch (err) {
            console.error("Error processing WebSocket message:", err);
          }
        };
        ws.onclose = () => {
          console.log("WebSocket closed, retrying...");
          statusDiv.textContent = "Chat disconnected. Retrying...";
          retryCount++;
          setTimeout(() => connectWebSocket(rank, userAddress), RETRY_INTERVAL);
        };
        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
          statusDiv.textContent = "Chat connection error. Retrying...";
        };
      } catch (err) {
        console.error("Error connecting WebSocket:", err);
        statusDiv.textContent = `Error connecting to chat: ${err.message}`;
        retryBtn.style.display = "block";
      }
    }

    // Load chat messages
    async function loadMessages() {
      try {
        const response = await fetch(`${BACKEND_URL}/messages`);
        if (!response.ok) {
          throw new Error(`HTTP error: ${response.status}`);
        }
        const messages = await response.json();
        console.log("Loaded messages:", messages);
        chatMessages.innerHTML = "";
        messages.forEach((msg, index) => {
          if (msg.type !== "chat" || !msg.user || !msg.rank || !msg.text || !msg.timestamp) return;
          const messageDiv = document.createElement("div");
          messageDiv.className = "chat-message";
          const rankClass = `rank-${msg.rank.toLowerCase().replace(" ", "-")}`;
          const isAdmin = currentUser === ADMIN_WALLET;
          const isOwnMessage = msg.originalWallet === currentUser;
          messageDiv.innerHTML = `
            <div class="chat-user">
              <span class="${rankClass}">${msg.rank}</span>
              <span>${msg.user}</span>
            </div>
            <div class="chat-text">${msg.text}<hr>${new Date(msg.timestamp).toLocaleString()}</div>
            ${(isAdmin || isOwnMessage) ? `<span class="delete-btn" data-index="${index}">Delete</span>` : ""}
          `;
          chatMessages.appendChild(messageDiv);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Add delete event listeners
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            console.log("Delete button clicked:", btn.dataset.index);
            try {
              if (!ws || ws.readyState !== WebSocket.OPEN || !ws.isAuthenticated) {
                statusDiv.textContent = "Chat not connected. Please try again.";
                console.log("WebSocket not connected for delete");
                return;
              }
              ws.send(JSON.stringify({
                type: "delete",
                index: parseInt(btn.dataset.index),
                wallet: currentUser
              }));
              console.log("Sent delete message:", btn.dataset.index);
            } catch (err) {
              console.error("Error sending delete message:", err);
              statusDiv.textContent = `Error deleting message: ${err.message}`;
            }
          });
        });
      } catch (err) {
        console.error("Error loading messages:", err);
        statusDiv.textContent = `Error loading messages: ${err.message}`;
      }
    }

    // Send chat message
    sendChatBtn.addEventListener("click", () => {
      console.log("Send chat button clicked");
      try {
        const text = chatInput.value.trim();
        const username = document.getElementById("username-display").textContent;
        if (username === "Not set") {
          statusDiv.textContent = "Please set a username before chatting.";
          console.log("Username not set");
          return;
        }
        if (!text || !ws || ws.readyState !== WebSocket.OPEN || !ws.isAuthenticated) {
          statusDiv.textContent = !ws ? "Chat not connected." : "Please enter a message.";
          console.log("Invalid chat conditions:", { text, ws });
          return;
        }
        const message = {
          type: "chat",
          user: username,
          rank: userRank,
          text,
          timestamp: new Date().toISOString(),
          originalWallet: currentUser
        };
        ws.send(JSON.stringify(message));
        console.log("Sent chat message:", message);
        chatInput.value = "";
      } catch (err) {
        console.error("Error sending chat message:", err);
        statusDiv.textContent = `Error sending message: ${err.message}`;
      }
    });

    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        console.log("Enter key pressed in chat input");
        sendChatBtn.click();
      }
    });

    // Load suggestions
    async function loadSuggestions() {
      try {
        const response = await fetch(`${BACKEND_URL}/suggestions`);
        if (!response.ok) {
          throw new Error(`HTTP error: ${response.status}`);
        }
        const suggestions = await response.json();
        console.log("Loaded suggestions:", suggestions);
        suggestionsList.innerHTML = "";
        const isAdmin = currentUser === ADMIN_WALLET;
        suggestions.forEach((suggestion, index) => {
          if (!isAdmin && suggestion.wallet !== currentUser) return; // Only show own suggestions unless admin
          const suggestionP = document.createElement("p");
          suggestionP.innerHTML = `
            ${suggestion.username} (${suggestion.wallet.slice(0, 6)}...${suggestion.wallet.slice(-4)}): ${suggestion.suggestion}
            ${(isAdmin || suggestion.wallet === currentUser) ? `<span class="delete-btn" data-index="${index}">Delete</span>` : ""}
          `;
          suggestionsList.appendChild(suggestionP);
        });

        // Add delete event listeners for suggestions
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            console.log("Delete suggestion button clicked:", btn.dataset.index);
            try {
              const response = await fetch(`${BACKEND_URL}/delete-suggestion`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ index: parseInt(btn.dataset.index), wallet: currentUser }),
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error: ${response.status} - ${errorText}`);
              }
              const data = await response.json();
              statusDiv.textContent = data.message;
              console.log("Delete suggestion response:", data);
              loadSuggestions();
            } catch (err) {
              console.error("Error deleting suggestion:", err);
              statusDiv.textContent = `Error deleting suggestion: ${err.message}`;
            }
          });
        });
      } catch (err) {
        console.error("Error loading suggestions:", err);
        statusDiv.textContent = `Error loading suggestions: ${err.message}`;
      }
    }

    // Submit suggestion
    submitSuggestionBtn.addEventListener("click", async () => {
      console.log("Submit suggestion button clicked");
      try {
        const suggestion = suggestionInput.value.trim();
        if (!currentUser) {
          statusDiv.textContent = "Please connect your wallet.";
          console.log("No wallet connected");
          return;
        }
        if (document.getElementById("username-display").textContent === "Not set") {
          statusDiv.textContent = "Please set a username before submitting a suggestion.";
          console.log("Username not set");
          return;
        }
        if (!suggestion) {
          statusDiv.textContent = "Please enter a suggestion.";
          console.log("No suggestion entered");
          return;
        }
        const response = await fetch(`${BACKEND_URL}/submit-free-suggestion`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet: currentUser, suggestion }),
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error: ${response.status} - ${errorText}`);
        }
        const data = await response.json();
        statusDiv.textContent = data.message;
        console.log("Submit suggestion response:", data);
        suggestionInput.value = "";
        loadSuggestions();
      } catch (err) {
        console.error("Error submitting suggestion:", err);
        statusDiv.textContent = `Error submitting suggestion: ${err.message}`;
      }
    });

    suggestionInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        console.log("Enter key pressed in suggestion input");
        submitSuggestionBtn.click();
      }
    });

    // Load rewards
    async function loadRewards() {
      try {
        if (!currentUser) {
          statusDiv.textContent = "Please connect your wallet.";
          console.log("No wallet connected");
          return;
        }
        const response = await fetch(`${BACKEND_URL}/rewards/${currentUser}`);
        if (!response.ok) {
          throw new Error(`HTTP error: ${response.status}`);
        }
        const { balance, dailyReward, canClaim } = await response.json();
        console.log("Loaded rewards:", { balance, dailyReward, canClaim });
        rewardsList.innerHTML = `
          <tr>
            <td>${balance.toLocaleString()} SMM</td>
            <td>${dailyReward.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} SMM</td>
            <td>${canClaim ? "Claimable" : "Already Claimed (Next: " + new Date(Date.now() + (24 * 60 * 60 * 1000 - (Date.now() - (await getLastClaimTime())))).toLocaleString() + ")"}</td>
            <td><button class="retry-button claim-reward-btn" ${!canClaim ? "disabled" : ""}>Claim Reward</button></td>
          </tr>
        `;
        document.querySelectorAll(".claim-reward-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            console.log("Claim reward button clicked");
            try {
              const response = await fetch(`${BACKEND_URL}/claim-reward`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ walletAddress: currentUser }),
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error: ${response.status} - ${errorText}`);
              }
              const data = await response.json();
              statusDiv.textContent = `Claimed ${data.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} SMM! Transaction: ${data.signature}`;
              console.log("Claim reward response:", data);
              loadRewards();
            } catch (err) {
              console.error("Error claiming reward:", err);
              statusDiv.textContent = `Error claiming reward: ${err.message}`;
            }
          });
        });
      } catch (err) {
        console.error("Error loading rewards:", err);
        statusDiv.textContent = `Error loading rewards: ${err.message}`;
      }
    }

    // Helper to get last claim time
    async function getLastClaimTime() {
      try {
        const response = await fetch(`${BACKEND_URL}/rewards/${currentUser}`);
        const { lastClaim } = await response.json();
        return lastClaim || 0;
      } catch (err) {
        console.error("Error fetching last claim time:", err);
        return 0;
      }
    }

    // Retry connection
    retryBtn.addEventListener("click", () => {
      console.log("Retry button clicked");
      retryCount = 0;
      retryBtn.style.display = "none";
      checkWallet();
    });

    // Initial wallet check
    checkWallet();
  </script>
</body>
</html>