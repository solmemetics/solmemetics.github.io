<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solmemetics Main</title>
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/dist/index.iife.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      text-align: center;
      background-color: #f0f0f0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    #status {
      margin-top: 10px;
      color: #333;
    }
    img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <h1>Solmemetics</h1>
  <img src="your-image.png" alt="solmemetics-icon" />
  <p id="status">Status: Disconnected</p>
  <p>Balance: <span id="balance">0</span> SMM</p>
  <button id="connect">Connect</button>
  <button id="vipBtn" disabled>VIP Access</button>

  <script>
    const TOKEN_MINT = new solanaWeb3.PublicKey("BbDK2SdFKstCuCjF152jWaRVmJMV7hHUW4xYvdMbjups");
    const VIP_MINIMUM = 100000;
    const status = document.getElementById("status");
    const balanceSpan = document.getElementById("balance");
    const connectBtn = document.getElementById("connect");
    const vipBtn = document.getElementById("vipBtn");
    let cachedBalance = 0;

    const RPC_ENDPOINTS = [
      "https://silent-fluent-diamond.solana-mainnet.quiknode.pro/bdf6a6133f8736f5bf9097f4628841fe18b60bcc",
      solanaWeb3.clusterApiUrl("mainnet-beta"),
      "https://api.mainnet-beta.solana.com"
    ];

    async function getConnection(attempt = 0) {
      const rpc = RPC_ENDPOINTS[attempt];
      try {
        const connection = new solanaWeb3.Connection(rpc, { commitment: "confirmed", disableRetryOnRateLimit: false });
        await connection.getSlot();
        console.log(`Connected to RPC: ${rpc}`);
        return connection;
      } catch (err) {
        console.error(`RPC ${rpc} failed:`, err);
        if (attempt < RPC_ENDPOINTS.length - 1) return getConnection(attempt + 1);
        throw new Error("All RPC endpoints failed.");
      }
    }

    async function updateBalance(publicKey) {
      try {
        const connection = await getConnection();
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
          publicKey,
          { mint: TOKEN_MINT, programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
        );
        let tokenBalance = 0;
        for (const { account } of tokenAccounts.value) {
          if (account.data.parsed.info.mint === TOKEN_MINT.toBase58()) {
            tokenBalance = parseFloat(account.data.parsed.info.tokenAmount.uiAmount);
            break;
          }
        }
        cachedBalance = tokenBalance;
        balanceSpan.textContent = tokenBalance.toLocaleString();
        status.textContent = `Connected: ${publicKey.toBase58().slice(0, 6)}...`;
        vipBtn.disabled = tokenBalance < VIP_MINIMUM;
      } catch (err) {
        console.error("Balance fetch failed:", err);
        status.textContent = `Error fetching balance: ${err.message}`;
        vipBtn.disabled = true;
      }
    }

    connectBtn.addEventListener("click", async () => {
      if (!window.solana || !window.solana.isPhantom) {
        status.textContent = "Phantom Wallet required. Install it here.";
        window.open("https://phantom.app/", "_blank");
        return;
      }
      try {
        const resp = await window.solana.connect();
        const publicKey = resp.publicKey;
        sessionStorage.setItem("smmPublicKey", publicKey.toBase58());
        await updateBalance(publicKey);
      } catch (err) {
        console.error("Connection failed:", err);
        status.textContent = "Failed to connect wallet. Try again.";
      }
    });

    vipBtn.addEventListener("click", () => {
      if (cachedBalance >= VIP_MINIMUM) {
        sessionStorage.setItem("smmVipVerified", "true");
        window.location.href = "vip.html";
      } else {
        status.textContent = `Need ${VIP_MINIMUM.toLocaleString()} SMM for VIP access. Current: ${cachedBalance.toLocaleString()} SMM`;
      }
    });

    window.addEventListener("load", () => {
      const storedPublicKey = sessionStorage.getItem("smmPublicKey");
      if (storedPublicKey && window.solana?.isConnected) {
        updateBalance(new solanaWeb3.PublicKey(storedPublicKey));
      }
    });
  </script>
</body>
</html>